# LINE×Googleスプレッドシート シフト要注意通知 要件定義書（初版）

- 作成日: 2025-09-09（JST）
- 版数: v0.1 / 初版ドラフト
- 想定開発言語: Python
- 想定外部サービス: LINE Messaging API, Google APIs（Google Sheets API / Google Drive API /（将来）Cloud Vision API もしくは Document AI）

---

## 1. 背景・目的
看護現場（病棟、外来、老健、訪問看護 など）において、特定の組み合わせで勤務すると心理的・業務的ストレスが高まることがある。Googleスプレッドシートで管理しているシフト表を基に、ユーザーが事前に登録した「苦手な人（相性に注意したい同僚）」と同一シフトになった場合に、LINEで注意喚起メッセージを自動送信する仕組みを実現する。将来的には、紙のシフト表の写真をLINEへ送ると、自動で表データに変換し、Googleスプレッドシートへ反映する機能を追加する。

## 2. 目標/KPI（初期案） 目標/KPI（初期案）
- 通知精度（誤検知/検知漏れを含む）: 99% 以上
- 通知の遅延: 予定時刻±5分以内
- 初回オンボーディング時間（ユーザーが使い始めて設定完了まで）: 5分以内
- （将来）画像→表変換のセル正解率: 95% 以上 / 人名一致率 99% 以上

## 3. ユーザー/ステークホルダー
- 一般ユーザー（看護スタッフ全般: 看護師・准看護師・看護補助者等／診療科不問）: 自分の勤務と「苦手な人」重複をLINEで受け取りたい
- 管理者（任意）: シートID・施設共通設定の管理
- 開発/運用担当: Pythonサーバの保守、APIキー/トークンの管理

## 4. 用語定義
- **対象シート**: Googleスプレッドシートで管理されるシフト表
- **苦手な人**: ユーザーが回避・注意したい同僚を示す設定
- **一致判定**: 同一日・同一勤務帯（例: 日勤/準夜/深夜 等）でユーザーと相手が並存すること

## 5. スコープ
**対象領域:** 診療科を問わず看護現場全般（病棟・外来・在宅等）。
### 5.1 本リリース（v1）
- 対象領域: 診療科不問（一般、外科、小児、救急、精神科 などの看護現場で利用可能）
- Googleスプレッドシート読取によるシフト解析
- ユーザー別「苦手な人」登録/編集/確認（LINE上の対話UI）
- 一致判定と定期通知（前日19:00、当日07:00など、時刻は設定可）
- 通知テンプレートの管理（ユーザー単位の言い回し変更）

### 5.2 将来拡張（v1.1+）
- LINEで受信したシフト表画像のOCR/表構造化 → スプレッドシート自動反映
- 複数シート/複数部署の横断検索
- 代替案提案（相手がいる日を回避する休暇申請・希望調整の補助）

### 5.3 非スコープ（当面）
- 本人以外のシフト自動編集・自動申請
- 人事評価や人間関係の診断等

## 6. ユースケース
1. 初回設定：
   - ユーザーがLINEでBotを友だち追加 → シートIDの紐付け → 自身の氏名/ニックネームの宣言 → 苦手な人を検索・選択（複数可）
2. 通常運用：
   - 毎日、所定時刻に翌日/当日の一致判定を行い、該当時のみLINEで通知
3. 確認/修正：
   - コマンド（例：`設定` / `苦手一覧` / `追加` / `削除` / `テスト通知`）で設定や挙動を確認・変更
4. 将来：
   - 紙シフトの写真をLINEで送信 → OCR → スプレッドシートへ反映 → 通知ロジックへ即時反映

## 7. 機能要件
### 7.1 シフトデータ連携（Google Sheets）
- 指定のスプレッドシートID・シート名を設定で保持
- シートの構造差（横=日付/縦=スタッフ など）を吸収する「マッピング設定」を用意
- 取得頻度：定期バッチ（例: 1日2回）＋オンデマンド（ユーザー操作）
- シート更新差分を検出し、判定に最新を利用

### 7.2 苦手な人設定（LINE対話UI）
- ユーザー本人の氏名/識別子を確定（例：氏名候補から選択 or 手入力→曖昧マッチ）
- シート上の職員名一覧から検索し、`クイックリプライ`で候補提示
- 追加/削除/一覧表示、上限数（例：最大50名）
- 秘匿性配慮：本人とBot間のみで設定・表示、他者には開示しない

### 7.3 一致判定
- 同一日かつ同一勤務帯でユーザーと対象相手が含まれるかを判定
- 勤務帯キー（例：`日勤` / `準夜` / `深夜` / `早出` など）を設定可能
- 氏名ゆらぎ（全角/半角、スペース、旧姓/略称）へのロバスト性（別名マスタ）

### 7.4 通知
- 既定の送信時刻：前日19:00 / 当日07:00（JST、ユーザー単位で変更可）
- 通知条件：一致がある日だけ送信（重複防止のため送信履歴でデデュープ）
- 文面テンプレ：
  - 例）`明日（9/10・日勤）、Aさんと同じシフトです。事前に準備しておきましょう。`
  - 例）`本日（9/10・準夜）、Bさんと同じ勤務です。休憩場所など環境調整を検討してください。`
- 緊急モード（任意）：当日変更が入った場合の即時通知

### 7.5 監査・ログ
- 取得/判定/通知の各イベントを時刻・ユーザー・結果付きで記録
- エラー時のスタックトレース/リトライ回数も保持

### 7.6 管理・設定
- シートID、シート名、列/行マッピング、勤務帯キー、通知時刻、タイムゾーン
- 管理者のみ変更可（LINE管理コマンド or 管理UIは将来）

### 7.7 将来: 画像→表変換
- 受信画像の前処理（傾き補正/トリミング/コントラスト）
- OCR（Cloud Vision API または Document AI）＋表構造推定
- セルと人名の突合（曖昧一致/シノニム）
- 差分のみをスプレッドシートへ反映（ロールバック可能）

## 8. 非機能要件
- 可用性: 99.5% 稼働（夜間メンテ枠除く）
- 性能: 1,000ユーザーまで通知バッチが5分以内に完了
- セキュリティ:
  - LINEユーザーIDと設定データは最小限で保持し、暗号化保管（KMS）
  - Google OAuth スコープ最小化（`spreadsheets.readonly`, `drive.readonly`/`drive.file` など）
  - 通信はTLS、署名検証（LINEチャネルシークレット）
- ログ/監視: 構造化ログ、エラーレート/レイテンシ監視、死活監視
- プライバシ: 苦手設定は本人のみ閲覧可。第三者提供なし。
- 法令/倫理: 個人情報の取扱い方針、削除要請に応じた消去機能

## 9. データ設計（スプレッドシート構成案）
### 9.1 シート一覧
| シート名 | 目的 | 主な列 |
|---|---|---|
| `Shifts` | シフト表（マスタ） | `date` (YYYY-MM-DD), `weekday`, `slot` (日勤/準夜/深夜等), `staff_name` |
| `Aliases` | 氏名ゆらぎ/別名 | `canonical_name`, `alias` |
| `Users` | Botユーザー | `line_user_id`, `my_name`, `sheet_id`, `timezone`, `notify_times` |
| `AvoidList` | 苦手リスト | `line_user_id`, `target_name`, `note`, `created_at` |
| `SendLog` | 送信履歴 | `sent_at`, `line_user_id`, `date`, `slot`, `targets`, `message_id` |

### 9.2 ID/キー方針
- 人名は `canonical_name` を内部キーに、別名は `Aliases` で吸収
- 勤務帯は `slot` の定義一覧を設定で管理（例: `{'D':'日勤','E':'準夜','N':'深夜'}`）

## 10. 外部インターフェース
### 10.1 LINE Messaging API（Webhook）
- エンドポイント: `POST /line/webhook`
- 受信イベント: `message`, `postback`, `follow`, `unfollow`
- 署名検証: チャネルシークレット
- 代表コマンド例：
  - `設定` → シートID登録/自分の氏名設定フロー開始
  - `苦手追加` → 候補提示→選択で `AvoidList` に追加
  - `苦手一覧` → 現在の登録一覧を返す
  - `苦手削除` → 選択削除
  - `テスト通知` → 次回通知のプレビュー

### 10.2 Google APIs
- Sheets API: 読取（初期は ReadOnly）。将来は書込（画像→表反映）
- Drive API: 画像一時保管、（将来）バックアップ
- OAuth スコープ最小化: `spreadsheets.readonly`, `drive.readonly`（書込時は `drive.file`）

## 11. アーキテクチャ（案）
```
[LINE] ──(Webhook)──> [FastAPI / Python] ── Sheets API → [Google Sheets]
   │                               │
   └──(Push Message) <─────────────┘

スケジューラ（例: Cloud Scheduler or cron）
  → 定時に /jobs/notify を叩き、判定→送信
```
- 実行環境:
  - クラウド案: Google Cloud Run（自動スケール、デプロイ容易）
  - 代替: VPS/オンプレ + systemd + cron
- ジョブ: `/jobs/notify?scope=all`（全ユーザー）または `/jobs/notify?user=<id>`
- 構成管理: `.env` にトークン類（LINEアクセストークン/シークレット、GCPサービスアカウント）

## 12. 通知ロジック（擬似コード）
```
for user in Users:
  cfg = load_user_config(user)
  shifts = load_shifts(cfg.sheet_id)
  my_slots = pick_my_rows(shifts, user.my_name)
  targets = load_avoid_list(user)
  matches = find_overlaps(my_slots, shifts, targets)  # 同日・同帯
  dedup = exclude_already_sent(matches, SendLog)
  if dedup:
    send_line_message(user.line_user_id, build_message(dedup))
    log_send(SendLog, user, dedup)
```

## 13. エラー処理/フォールバック
- Sheets取得失敗: リトライ（指数バックオフ）、最終失敗時に管理者通知
- 氏名不一致: あいまい検索の候補提示、`Aliases` 追記を促す
- LINE送信失敗: レート制限検知→再送、長文は分割
- 画像OCR失敗（将来）: ユーザーに再撮影ガイド（斜め・影・解像度）

## 14. セキュリティ・プライバシ
- データ最小化: 保存は `line_user_id` / `my_name` / `AvoidList` のみ（業務上必要な最小セット）
- 暗号化: 保存時（KMS/At-Rest）、転送時（TLS）
- ログ方針: 個人名はハッシュ化オプション、保管期間（例: 90日）
- 削除要請: LINE上のコマンド（`データ削除`）で即時削除フロー

## 15. テスト観点（抜粋）
- 単体: シートパーサ、名前照合、通知フォーマッタ
- 結合: Webhook→設定→判定→送信 までのE2E
- 回帰: マッピング変更/別名追加時に互換性維持
- 負荷: 1,000ユーザー・1分以内で判定完了
- 異常系: Sheets 404、APIクォータ超過、LINE 429

## 16. 受け入れ条件（サンプル）
- 自分と「苦手な人」が同一日・同一勤務帯のすべてのケースで通知される
- 設定変更（追加/削除）が即時次回バッチに反映
- 二重通知なし（同一キー: `date+slot+target`）
- タイムゾーンがJSTで正しく動作（前日/当日判定のズレなし）

## 17. 開発・運用計画（マイルストーン案）
- M1: シート読取+一致判定のCLI（ローカル）
- M2: LINE連携（Webhook+Push）/ 苦手設定UI（対話コマンド）
- M3: スケジューラ通知 / ログ・監視
- M4: 画像→表のPoC（Vision or Document AI）
- M5: 画像→表 本実装 / 書込反映 / ロールバック

## 18. 参考設計（FastAPI エンドポイント案）
```http
GET  /healthz               # ヘルスチェック
POST /line/webhook          # LINE Webhook
POST /jobs/notify           # 通知実行（認証付き）
POST /admin/reload-mapping  # マッピング更新（管理者）
```

## 19. メッセージUI例（LINE）
- `設定` → シートID入力 → シート接続確認 → 自分の氏名候補を提示 → 決定
- `苦手追加` → 人名検索テキスト → 候補（クイックリプライ）→ 追加完了
- `苦手一覧` → 現在の登録（削除ボタン付きテンプレ）
- `通知サンプル` → 直近7日の一致サマリを生成

## 20. 将来の技術選択メモ
- OCR/表抽出:
  - **Cloud Vision**（汎用OCR, 手軽）
  - **Document AI**（表抽出に強い, 学習/設定コスト）
  - **Tesseract**（OSS, カスタム前処理必要）
- 名前あいまい一致: RapidFuzz 等（Python）

---

## 付録A: 初学者向け用語集（このプロジェクトで出てくる言葉）

> できるだけ短く、ざっくり分かる説明にしています。困ったらこの章を見ればOK。

### 基本の概念
- **API（エーピーアイ）**: サービス同士が話すための“決まりごと”。LINEやGoogleに「これください」と頼む窓口。
- **SDK**: APIを使いやすくする“便利道具セット”。Python用のSDKなど。
- **エンドポイント**: APIの入り口のURL。例: `/line/webhook`, `/jobs/notify`。
- **Webhook（ウェブフック）**: 先方（LINEなど）からこちらのURLに“通知を飛ばしてくれる仕組み”。
- **Pushメッセージ**: こちらから相手（ユーザー）へLINEで能動的に送るメッセージ。

### 設計まわり
- **ラッパ（Wrapper）**: 本家のAPI呼び出しを“包む”薄い関数。毎回同じ書き方をしなくてよくなる。
  - 例: `line_client.send_text(user_id, text)` の中で公式SDKを呼ぶ。
- **アダプタ（Adapter）**: 外部サービスとの“接続口”をまとめた層。将来、別サービスに差し替えてもアプリ本体はあまり変えなくて済む。
- **リポジトリ（Repository）**: データの出し入れを担当する“倉庫係”。SheetsでもDBでも同じインターフェースで扱う。
- **サービス（Service）**: ビジネスロジックを置く場所。通知の組み立て、シフト一致判定など。
- **モデル / ドメインモデル**: 取り扱うデータの“型”。例: `Shift`, `User`, `Message`。
- **Pydanticモデル**: 入出力の型チェックを自動でしてくれるPythonの仕組み。FastAPIと相性◎。
- **ルーティング**: URLに来たリクエストをどの関数へ渡すかの振り分け。
- **ミドルウェア**: 共通処理（ログ、エラー変換など）を横断的に差し込む層。

### セキュリティ/認証
- **署名検証**: Webhookが本当にLINEから来たかを秘密の鍵（チャネルシークレット）で確認すること。
- **シークレット / アクセストークン**: APIを使うための“鍵”。外に漏らさない。
- **OAuth スコープ**: Googleに「どこまで触っていいか」を申請する範囲。最小権限が基本。
- **TLS**: 通信の暗号化。URLが`https://`になっていればTLSで守られている。
- **KMS**: 鍵を安全に保管・管理するクラウドのサービス（Key Management Service）。
- **レート制限**: 一定時間に呼べる回数の上限。超えたら待つ必要あり。
- **指数バックオフ**: 失敗したら待ち時間を倍々に伸ばして再試行するやり方。
- **冪等（べきとう）/Idempotency**: 同じ操作を何度しても結果が変わらない性質（重複送信を避けられる）。

### 運用・インフラ
- **インフラ**: アプリを動かす土台（サーバ、ネットワーク、コンテナ、監視など）ぜんぶ。
- **Docker**: アプリ一式を“コンテナ”に詰めてどこでも同じように動かす道具。
- **Dockerfile**: その“詰め方”のレシピ。
- **docker-compose**: 複数コンテナ（アプリ、DB、ngrok等）をまとめて起動するツール。
- **Cloud Run**: Googleの“コンテナを置くだけでWebサービス化”してくれるサービス。スケール自動。
- **cron / Cloud Scheduler**: 定期実行（毎朝7時など）を予約する仕組み。ローカルは`cron`、GCPはCloud Scheduler。
- **APScheduler**: Pythonアプリ内で“簡易スケジューラ”を動かすライブラリ。
- **IaC / Terraform**: インフラ構成をコードで管理する考え方／ツール。再現性が高まる。
- **ngrok**: ローカルPCを一時的にインターネット公開してWebhook受信を試すためのトンネル。
- **環境変数 / .env**: 鍵や設定値をソースコードに直書きせず外から渡す箱。`.env`はその見本ファイル。
- **構造化ログ**: 検索しやすい形式（JSONなど）で出すログ。監視やデバッグが楽。

### データ/業務ロジック
- **マッピング**: “この列が日付、この行がスタッフ”など、バラバラなシート構造を統一的に読み解く設定。
- **デデュープ**: 重複（同じ内容の通知など）を取り除くこと。
- **テナント**: 複数の施設や部署を“お客様単位”で分けて扱う考え方。

### プロジェクト運営
- **PoC（ピーオーシー）**: 検証目的の最小実験。まずは動くか確かめる段階。
- **MVP**: 必要最小限の機能だけに絞った“最初の製品”。
- **ユニットテスト**: 小さな関数ごとのテスト。
- **インテグレーションテスト**: つなげて動かした時のテスト（Webhook→通知までなど）。
- **E2E（エンドツーエンド）**: 入口から出口まで本番に近い形で通しで試すテスト。

### フォーマット
- **JSON**: データのやり取りでよく使うテキスト形式（`{ "name": "A" }`）。
- **YAML**: 人間が読みやすい設定ファイル形式（インデントが鍵）。

---

### 備考
- 本書はドラフトです。実データのシート例（列/行パターン）を頂ければ、マッピング仕様を具体化します。

